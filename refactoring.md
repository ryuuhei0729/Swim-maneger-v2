# 水泳選手マネジメントシステム コードレビュー・リファクタリング提案

## 1. アーキテクチャ・設計レビュー

### 1.1 データベース設計レビュー

#### 確認対象ファイル
- `supabase/migrations/20250916000000_initial_schema.sql`
- `supabase/migrations/remote_migration.sql`

#### 発見された問題点

**1. テーブル命名の一貫性**
- `practice_logs` vs `practice_times` - 命名規則が統一されていない
- `practice_tags` vs `practice_log_tags` - 関連テーブルの命名が冗長

**2. 外部キー制約の不備**
- `practice_logs`テーブルで`practice_id`が必須だが、個人練習の場合にNULLが許可されていない
- `practice_times`テーブルで`practice_log_id`の外部キー制約が適切に設定されていない

**3. インデックス設計の不足**
- 頻繁にクエリされる`practice_date`、`competition_date`にインデックスが不足
- `user_id`、`team_id`での検索性能が最適化されていない

**4. データ型の最適化**
- `circle`フィールドが`DECIMAL(10,2)`だが、実際の使用範囲を考慮すると`DECIMAL(5,2)`で十分
- `time`フィールドの精度が統一されていない

#### AI Prompt
```
データベーススキーマの最適化をお願いします：

1. パフォーマンス向上のためのインデックスを追加してください（practice_date, competition_date, user_id, team_id）
2. RLS（Row Level Security）ポリシーを全てのテーブルに適用してください

対象ファイル: supabase/migrations/20250916000000_initial_schema.sql
```

### 1.2 GraphQLスキーマ設計レビュー

#### 確認対象ファイル
- `supabase/functions/graphql/schema.ts`

#### 発見された問題点

**1. スキーマの一貫性**
- `PracticeLog`の`tags`フィールドがnullableだが、実際の使用では常に配列が期待されている
- エラーハンドリングの型定義が不足している

**2. クエリの最適化**
- 深いネストしたクエリでN+1問題が発生する可能性
- ページネーション機能が実装されていない

**3. ミューテーション設計**
- バッチ操作（一括作成・更新・削除）が不足
- 楽観的更新（Optimistic Updates）のサポートが不十分

#### AI Prompt
```
GraphQLスキーマの改善をお願いします：

1. エラーハンドリング用の型定義を追加してください（Error, ValidationError等）
2. ページネーション機能を実装してください（Connection, Edge, PageInfo型）
3. バッチ操作用のミューテーションを追加してください（bulkCreate, bulkUpdate, bulkDelete）
4. 楽観的更新をサポートするためのフィールドを追加してください（version, optimisticId等）
5. クエリの深いネストを避けるため、適切なリゾルバー設計を提案してください

対象ファイル: supabase/functions/graphql/schema.ts
```

### 1.3 プロジェクト構造レビュー

#### 確認対象ファイル
- 全体のディレクトリ構成

#### 発見された問題点

**1. 責務分離の不備**
- `apps/web/app/(authenticated)/dashboard/page.tsx`が肥大化している（930行）
- ビジネスロジックとUIロジックが混在している

**2. コンポーネント設計**
- 再利用可能なコンポーネントの抽出が不十分
- カスタムフックの活用が不足している

**3. 型定義の散在**
- 型定義が各ファイルに散らばっている
- 共通の型定義ファイルが不足している

#### AI Prompt
```
プロジェクト構造のリファクタリングをお願いします：

1. dashboard/page.tsxを複数のコンポーネントに分割してください（現在930行）
2. ビジネスロジックをカスタムフックに抽出してください（usePracticeManagement, useRecordManagement等）
3. 共通の型定義ファイル（types/index.ts）を作成し、型定義を集約してください
4. 再利用可能なコンポーネントを抽出してください（PracticeCard, RecordCard, Calendar等）
5. ディレクトリ構造を機能別に再編成してください

対象ファイル: apps/web/app/(authenticated)/dashboard/page.tsx
```

## 2. 認証・セキュリティレビュー

### 2.1 認証フローレビュー

#### 確認対象ファイル
- `apps/web/contexts/AuthProvider.tsx`

#### 発見された問題点

**1. エラーハンドリングの不備**
- 認証エラーの詳細な分類が不足
- ユーザーフレンドリーなエラーメッセージが不足

**2. セッション管理**
- セッションの有効期限管理が不十分
- リフレッシュトークンの処理が実装されていない

**3. セキュリティ強化**
- パスワード強度チェックが不足
- アカウントロック機能が実装されていない

#### AI Prompt
```
認証システムのセキュリティ強化をお願いします：

1. 詳細なエラーハンドリングを実装してください（認証失敗、アカウントロック、セッション期限切れ等）
2. セッション管理を強化してください（自動リフレッシュ、セッション期限管理）
3. パスワード強度チェック機能を追加してください
4. アカウントロック機能を実装してください（連続ログイン失敗時の制限）
5. セキュリティログ機能を追加してください（ログイン試行、異常なアクセス等）

対象ファイル: apps/web/contexts/AuthProvider.tsx
```

### 2.2 RLS（Row Level Security）レビュー

#### 確認対象ファイル
- `supabase/migrations/` のRLSポリシー

#### 発見された問題点

**1. RLSポリシーの不備**
- 一部のテーブルでRLSが有効化されていない
- ポリシーのテストが不足している

**2. 権限管理の複雑性**
- チーム内権限の管理が複雑
- 管理者権限の委譲機能が不足

#### AI Prompt
```
RLS（Row Level Security）の強化をお願いします：

1. 全てのテーブルにRLSを適用してください
2. チーム内権限管理のポリシーを詳細に実装してください（admin, user, swimmer, coach等）
3. RLSポリシーのテストケースを作成してください
4. 権限の委譲機能を実装してください（管理者の代理操作等）
5. セキュリティ監査ログを実装してください

対象ファイル: supabase/migrations/20250916000000_initial_schema.sql
```

## 3. コア機能レビュー

### 3.1 ダッシュボード機能レビュー

#### 確認対象ファイル
- `apps/web/app/(authenticated)/dashboard/page.tsx`

#### 発見された問題点

**1. コンポーネントの肥大化**
- 930行の巨大なコンポーネント
- 複数の責務が混在している

**2. 状態管理の複雑性**
- 複数のuseStateが散在
- 状態の同期が複雑

**3. パフォーマンス問題**
- 不要な再レンダリングが発生
- メモ化が不十分

#### AI Prompt
```
ダッシュボードコンポーネントのリファクタリングをお願いします：

1. 930行のコンポーネントを機能別に分割してください（Calendar, PracticeForm, RecordForm等）
2. 状態管理をuseReducerまたはZustandに移行してください
3. パフォーマンス最適化のため、React.memo, useMemo, useCallbackを適切に使用してください
4. カスタムフックを抽出してください（useCalendarData, usePracticeManagement等）
5. エラーバウンダリーを実装してください

対象ファイル: apps/web/app/(authenticated)/dashboard/page.tsx
```

### 3.2 練習記録機能レビュー

#### 確認対象ファイル
- `apps/web/components/forms/PracticeLogForm.tsx`

#### 発見された問題点

**1. フォーム処理の複雑性**
- 複雑なネストした状態管理
- バリデーションロジックが散在

**2. ユーザビリティ**
- フォームの入力体験が改善の余地
- エラーメッセージの表示が不十分

#### AI Prompt
```
練習記録フォームの改善をお願いします：

1. React Hook Formを使用してフォーム処理を簡素化してください
2. バリデーションロジックを集約し、エラーメッセージを改善してください
3. フォームの入力体験を向上させてください（オートセーブ、入力補完等）
4. アクセシビリティを向上させてください（ARIA属性、キーボードナビゲーション等）
5. フォームの状態管理を最適化してください

対象ファイル: apps/web/components/forms/PracticeLogForm.tsx
```

## 4. データ管理レビュー

### 4.1 GraphQLクエリ・ミューテーションレビュー

#### 確認対象ファイル
- `apps/web/graphql/queries/`
- `apps/web/graphql/mutations/`

#### 発見された問題点

**1. クエリの最適化**
- 不要なフィールドの取得
- キャッシュ戦略の不備

**2. エラーハンドリング**
- GraphQLエラーの処理が不統一
- ネットワークエラーの処理が不足

#### AI Prompt
```
GraphQLクエリ・ミューテーションの最適化をお願いします：

1. クエリの最適化を行ってください（必要なフィールドのみ取得、適切なキャッシュ設定）
2. エラーハンドリングを統一してください（GraphQLエラー、ネットワークエラー等）
3. 楽観的更新を実装してください（UIの応答性向上）
4. クエリの分割を行ってください（大きなクエリを小さなクエリに分割）
5. 型安全性を向上させてください（GraphQL Code Generatorの活用）

対象ファイル: apps/web/graphql/queries/, apps/web/graphql/mutations/
```

### 4.2 Apollo Client設定レビュー

#### 確認対象ファイル
- `apps/web/lib/apollo-client.ts`

#### 発見された問題点

**1. キャッシュ設定**
- キャッシュポリシーが最適化されていない
- メモリリークの可能性

**2. エラーハンドリング**
- グローバルエラーハンドリングが不十分
- リトライ機能が不足

#### AI Prompt
```
Apollo Client設定の最適化をお願いします：

1. キャッシュポリシーを最適化してください（適切なfetchPolicy, errorPolicy設定）
2. グローバルエラーハンドリングを実装してください（Apollo Link使用）
3. リトライ機能を実装してください（ネットワークエラー時の自動リトライ）
4. メモリリークを防ぐための設定を追加してください
5. 開発環境でのデバッグ機能を強化してください

対象ファイル: apps/web/lib/apollo-client.ts
```

## 5. UI/UXコンポーネントレビュー

### 5.1 共通コンポーネントレビュー

#### 確認対象ファイル
- `apps/web/components/`

#### 発見された問題点

**1. コンポーネント設計**
- 再利用性が低い
- プロップスの型定義が不十分

**2. スタイリング**
- Tailwind CSSの使用が一貫していない
- レスポンシブデザインが不十分

#### AI Prompt
```
共通コンポーネントの改善をお願いします：

1. 再利用可能なコンポーネントライブラリを構築してください
2. プロップスの型定義を強化してください（厳密な型チェック）
3. Tailwind CSSの使用を統一してください（デザインシステムの構築）
4. レスポンシブデザインを改善してください（モバイルファースト）
5. アクセシビリティを向上させてください（WCAG準拠）

対象ファイル: apps/web/components/
```

### 5.2 フォーム処理レビュー

#### 確認対象ファイル
- `apps/web/components/forms/`

#### 発見された問題点

**1. バリデーション**
- クライアントサイドバリデーションが不十分
- サーバーサイドバリデーションとの不整合

**2. ユーザビリティ**
- フォームの入力体験が改善の余地
- エラーメッセージの表示が不十分

#### AI Prompt
```
フォーム処理の改善をお願いします：

1. React Hook Formを導入してフォーム処理を統一してください
2. バリデーションロジックを集約し、エラーメッセージを改善してください
3. フォームの入力体験を向上させてください（オートセーブ、入力補完等）
4. アクセシビリティを向上させてください（ARIA属性、キーボードナビゲーション等）
5. フォームの状態管理を最適化してください

対象ファイル: apps/web/components/forms/
```

## 6. パフォーマンス・最適化レビュー

### 6.1 キャッシュ戦略レビュー

#### 確認対象ファイル
- `apps/web/lib/apollo-client.ts`

#### 発見された問題点

**1. キャッシュ設定**
- キャッシュポリシーが最適化されていない
- メモリ使用量の最適化が不足

**2. データフェッチング**
- 不要な再フェッチが発生
- 楽観的更新の実装が不十分

#### AI Prompt
```
キャッシュ戦略の最適化をお願いします：

1. Apollo Clientのキャッシュポリシーを最適化してください
2. メモリ使用量を最適化してください（キャッシュサイズ制限、古いデータの削除）
3. 楽観的更新を実装してください（UIの応答性向上）
4. オフライン対応を実装してください（Service Worker使用）
5. パフォーマンス監視機能を追加してください

対象ファイル: apps/web/lib/apollo-client.ts
```

### 6.2 バンドルサイズ最適化レビュー

#### 確認対象ファイル
- `apps/web/package.json`
- `apps/web/next.config.js`

#### 発見された問題点

**1. 依存関係**
- 不要な依存関係が含まれている
- バンドルサイズが最適化されていない

**2. コード分割**
- 動的インポートが不十分
- チャンク分割が最適化されていない

#### AI Prompt
```
バンドルサイズの最適化をお願いします：

1. 不要な依存関係を削除してください
2. 動的インポートを実装してください（コード分割）
3. チャンク分割を最適化してください
4. Tree shakingを最適化してください
5. バンドルサイズの監視機能を追加してください

対象ファイル: apps/web/package.json, apps/web/next.config.js
```

---

## 総合的な改善提案

### 優先度の高い改善項目

1. **ダッシュボードコンポーネントの分割** (高優先度)
2. **認証システムのセキュリティ強化** (高優先度)
3. **データベーススキーマの最適化** (高優先度)
4. **GraphQLスキーマの改善** (中優先度)
5. **フォーム処理の統一** (中優先度)

### 実装順序の推奨

1. データベーススキーマの最適化
2. GraphQLスキーマの改善
3. 認証システムのセキュリティ強化
4. ダッシュボードコンポーネントの分割
5. フォーム処理の統一
6. パフォーマンス最適化

### 注意事項

- 各改善項目は段階的に実装することを推奨
- 既存機能への影響を最小限に抑える
- テストの実装を並行して行う
- パフォーマンス測定を継続的に実施する
